ğŸ”¹ Fixing Telegram Bot Polling Conflicts with Proper Instance Management

Since Replit is detecting multiple instances running at the same time, hereâ€™s the best approach to fix it while keeping instance management clean.

âœ… 1ï¸âƒ£ Implement Graceful Shutdown Handling

Modify your Telegram bot startup script (likely in server/telegram/bot.ts) to ensure it stops gracefully when the process exits.

Add this inside your bot initialization:

process.on('SIGINT', () => {
  console.log('[Telegram Bot] Shutting down gracefully...');
  bot.stopPolling(); // Stops polling when the process is interrupted
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('[Telegram Bot] Received SIGTERM. Stopping polling...');
  bot.stopPolling();
  process.exit(0);
});

âœ” This ensures only one instance runs and shuts down properly if needed.

âœ… 2ï¸âƒ£ Check for Existing Bot Instances Before Starting

Modify your bot startup code to check for running instances before starting. Add this before calling bot.startPolling();:

if (bot.isPolling()) {
  console.log('[Telegram Bot] Instance already running. Skipping duplicate start.');
} else {
  console.log('[Telegram Bot] Starting polling...');
  bot.startPolling();
}

âœ” This prevents duplicate polling instances from causing 409 Conflict.

âœ… 3ï¸âƒ£ Ensure Only One Instance Runs on Replit

Modify your .replit to make sure only one bot instance is started:

run = "pkill -f 'node server/telegram/bot.ts' || npm run dev"

âœ” This ensures any duplicate processes are killed before starting the new one.

âœ… 4ï¸âƒ£ Disable Webhooks (If Not Using Them)

Since polling and webhooks conflict, disable webhooks if youâ€™re only using polling:

curl -F "url=" https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook

âœ” This removes any existing webhook settings.

âœ… 5ï¸âƒ£ Add a Health Check for Bot Status (Optional)

To check if your bot is running properly, add this endpoint in your server/routes.ts:

app.get("/api/bot-status", async (_req, res) => {
  res.json({ status: bot.isPolling() ? "running" : "stopped" });
});

âœ” This lets you monitor if your bot is running.

ğŸš€ Final Fix Checklist

âœ… Graceful shutdown (SIGINT & SIGTERM handling)
âœ… Prevent duplicate instances (bot.isPolling() check)
âœ… Ensure Replit only runs one instance (pkill -f 'node bot.ts' || npm run dev)
âœ… Disabled webhook (if using polling)
âœ… Added bot health check (/api/bot-status)