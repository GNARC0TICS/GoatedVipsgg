<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORS Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      line-height: 1.5;
    }
    h1 {
      color: #333;
    }
    .result {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.5rem;
      background-color: #f5f5f5;
      overflow: auto;
      max-height: 400px;
    }
    .success {
      border-left: 4px solid green;
    }
    .error {
      border-left: 4px solid red;
    }
    button {
      background-color: #0070f3;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background-color: #0051b3;
    }
    pre {
      margin: 0;
    }
  </style>
</head>
<body>
  <h1>CORS Test Tool</h1>
  <p>Use this tool to test if the API endpoints are properly handling CORS requests.</p>
  
  <div>
    <button id="testHealth">Test Health Endpoint</button>
    <button id="testAffiliateStats">Test Affiliate Stats</button>
    <button id="testWagerRaces">Test Wager Races</button>
    <button id="testUser">Test User Endpoint</button>
  </div>
  
  <div id="results"></div>
  
  <script>
    // Debug flag
    const debug = true;
    
    // Log helper
    function debugLog(...args) {
      if (debug) {
        console.log('[CORS Test]', ...args);
      }
    }
    
    // Function to display results
    function displayResult(endpoint, success, data) {
      const resultsDiv = document.getElementById('results');
      const resultDiv = document.createElement('div');
      resultDiv.classList.add('result');
      resultDiv.classList.add(success ? 'success' : 'error');
      
      const timestamp = new Date().toLocaleTimeString();
      
      resultDiv.innerHTML = `
        <h3>${success ? '✅' : '❌'} ${endpoint}</h3>
        <p><strong>Time:</strong> ${timestamp}</p>
        <p><strong>Status:</strong> ${success ? 'Success' : 'Error'}</p>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
      
      resultsDiv.prepend(resultDiv);
    }
    
    // Function to test an endpoint
    async function testEndpoint(endpoint) {
      try {
        debugLog(`Testing endpoint: ${endpoint}`);
        
        // Get the current domain
        const currentDomain = window.location.origin;
        debugLog(`Current domain: ${currentDomain}`);
        
        // Construct the API URL
        const apiUrl = `${currentDomain}${endpoint}`;
        debugLog(`API URL: ${apiUrl}`);
        
        // Make the fetch request
        const response = await fetch(apiUrl, {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        
        debugLog(`Response status: ${response.status}`);
        
        // Parse the response
        const data = await response.json();
        debugLog('Response data:', data);
        
        // Display the result
        displayResult(endpoint, true, data);
        
        return { success: true, data };
      } catch (error) {
        debugLog('Error:', error);
        displayResult(endpoint, false, { error: error.message });
        return { success: false, error: error.message };
      }
    }
    
    // Event listeners for buttons
    document.getElementById('testHealth').addEventListener('click', () => testEndpoint('/api/health'));
    document.getElementById('testAffiliateStats').addEventListener('click', () => testEndpoint('/api/affiliate/stats'));
    document.getElementById('testWagerRaces').addEventListener('click', () => testEndpoint('/api/wager-races/current'));
    document.getElementById('testUser').addEventListener('click', () => testEndpoint('/api/user'));
    
    // Initial test of health endpoint
    window.addEventListener('load', () => {
      debugLog('Page loaded, testing health endpoint...');
      testEndpoint('/api/health');
    });
  </script>
</body>
</html>